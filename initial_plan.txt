Docker Compose Terraform/OpenTofu Provider â€” Project Plan
1. Overview

This project provides a Terraform/OpenTofu provider that manages a docker-compose file on a remote host. Terraform tracks only the compose file, while the provider offers optional lifecycle convenience operations (up/down) that do not become Terraform-tracked state.

The provider is intentionally minimal and avoids container-level lifecycle management, keeping it aligned with infrastructure-as-code principles.

2. Scope
2.1 In-Scope

Uploading a docker-compose file to a remote system

Detecting updates based on file hash changes

Removing the compose file on destroy

Optional convenience execution:

docker compose up -d

docker compose down

Optional runtime detection (e.g., to decide whether to run down before updates)

Validation of the compose file before applying

2.2 Out-of-Scope

Tracking container, volume, or network state

Image builds (build: instructions)

Monitoring or reconciling runtime drift

Managing Dockerfiles or build contexts

Managing multiple compose services as separate resources

3. Resource Design
Resource: docker_compose_stack
Tracked State

id

remote_path

compose_file_content (stored as hash / raw string)

User Inputs
resource "docker_compose_stack" "app" {
  remote_host            = "ssh://user@host"
  remote_path            = "/opt/stacks/app/docker-compose.yaml"
  compose_file_content   = file("docker-compose.yaml")
  up                     = true   # optional convenience flag
}

4. Lifecycle Behavior
Create

Upload compose file to remote.

Validate using docker compose config.

If up = true, run docker compose up -d.

Read

Retrieve remote file

Compute hash and compare

No inspection of running containers

Update

Triggered when compose_file_content changes.

Detect if containers are running
(optional: via docker compose ps --format json).

If up = true, run docker compose down.

Upload updated compose file.

Validate.

If up = true, run docker compose up -d.

Delete

Always run docker compose down (idempotent).

Remove compose file from remote.

5. Provider Capabilities
Core Behaviors

SSH connection + SCP file upload

Compose validation (docker compose config)

Optional container running detection (compose ps)

Up/Down execution

File hashing and drift detection

Optional Enhancements

Connection pooling / SSH multiplexing

Environment variable support (rendering temp .env files)

More detailed logs or events for operators

6. Risks & Considerations

Compose operations are not tracked; Terraform state does not guarantee containers are running.

Remote host must have Docker & docker-compose plugin installed.

Large compose files or slow SSH environments may introduce latency.

Non-idempotent docker compose up behavior can affect apply times.

7. Implementation Notes

Use terraform-plugin-framework (Go)

Store file hash in state to detect changes

Implement a thin execution wrapper for docker commands

Follow Terraform best practices for Create, Read, Update, Delete patterns

Keep runtime state separate from IaC-managed state